[gd_scene load_steps=4 format=3 uid="uid://dslh1c7rihy52"]

[ext_resource type="Texture2D" uid="uid://bxoyje2pq7nna" path="res://icon.svg" id="1_0f027"]

[sub_resource type="GDScript" id="GDScript_2c62f"]
resource_name = "Multiplayer"
script/source = "extends Node 

const PORT=4443

func _ready() -> void:
	if \"--server\" in OS.get_cmdline_args():
		print(\"Creating server\")
		var peer = ENetMultiplayerPeer.new()
		peer.create_server(PORT)
		multiplayer.multiplayer_peer = peer
			
		multiplayer.peer_connected.connect($\"../MultiplayerSpawner\"._on_player_connected)
		multiplayer.peer_disconnected.connect($\"../MultiplayerSpawner\"._on_player_disconnected)
	else:
		print(\"Creating Client\")
		var peer = ENetMultiplayerPeer.new()
		peer.create_client(\"127.0.0.1\", PORT)
		multiplayer.multiplayer_peer = peer
"

[sub_resource type="GDScript" id="GDScript_0f027"]
resource_name = "MultiplayerSpawner"
script/source = "extends MultiplayerSpawner

func _ready() -> void:
	if multiplayer.is_server():
		print(\"Spawning first Server PLayer\")
		await get_tree().process_frame 
		var player = load(\"res://entity_scene.tscn\").instantiate()
		player.name = str(1)
		player.position = Vector2(100, 100)
		get_node(spawn_path).add_child(player)

func _on_player_connected(id):
	print(\"Player connected: \", id)
	if multiplayer.is_server():
		var player = load(\"res://entity_scene.tscn\").instantiate()
		player.name = str(id)
		get_node(spawn_path).add_child(player)
		
func _on_player_disconnected(id):
	print(\"Player disconnected: \", id)
	if multiplayer.is_server():
		var player = get_node(spawn_path).get_node_or_null(str(id))  
		if player:
			player.queue_free()
"

[node name="Node2D" type="Node2D"]

[node name="Multiplayer" type="Node" parent="."]
script = SubResource("GDScript_2c62f")

[node name="MultiplayerSpawner" type="MultiplayerSpawner" parent="."]
_spawnable_scenes = PackedStringArray("uid://dub7iv64uw2iq")
spawn_path = NodePath("../SpawnContainer")
script = SubResource("GDScript_0f027")

[node name="SpawnContainer" type="Node2D" parent="."]
position = Vector2(171, 173)

[node name="Sprite2D" type="Sprite2D" parent="SpawnContainer"]
texture = ExtResource("1_0f027")
